package {{apiPackage}};

{{#rxInterface}}
import io.reactivex.rxjava3.core.Completable;
import io.vertx.rxjava3.core.AbstractVerticle;
import io.vertx.rxjava3.core.http.HttpServer;
import io.vertx.rxjava3.ext.web.Router;
import io.vertx.rxjava3.ext.web.openapi.RouterBuilder;
import io.vertx.rxjava3.openapi.contract.OpenAPIContract;
{{/rxInterface}}
{{^rxInterface}}
import io.vertx.core.AbstractVerticle;
import io.vertx.core.Future;
import io.vertx.core.Promise;
import io.vertx.core.http.HttpServer;
import io.vertx.ext.web.Router;
import io.vertx.ext.web.openapi.RouterBuilder;
import io.vertx.openapi.contract.OpenAPIContract;
{{/rxInterface}}
import io.vertx.core.http.HttpServerOptions;
import io.vertx.core.json.JsonObject;
import io.vertx.ext.web.openapi.RouterBuilderOptions;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class {{classname}}Verticle extends AbstractVerticle {
  static final Logger LOGGER = LoggerFactory.getLogger({{classname}}Verticle.class);

  HttpServer server;

  @Override
  {{^rxInterface}}public void start(Promise<Void> startPromise) throws Exception { {{/rxInterface}}
  {{#rxInterface}}public Completable rxStart() { {{/rxInterface}}
    OpenAPIContract.from(vertx, "{{specLocation}}")
      .flatMap(contract -> {
        final RouterBuilder routerBuilder = RouterBuilder.create(this.vertx, contract);
        routerBuilder.setOptions(factoryOptions);

        return {{^rxInterface}}Future.succeededFuture({{/rxInterface}}routerBuilder.createRouter(){{^rxInterface}}){{/rxInterface}};
      })
      .flatMap(openapiRouter -> {
        Router router = Router.router(vertx);

        server = vertx.createHttpServer(new HttpServerOptions().setPort({{serverPort}}).setHost("localhost"))
          .requestHandler(router);

        router.route("/*").subRouter(openapiRouter);

        router.route().last().handler(context ->
        context.response()
          .setStatusCode(404)
          .end(new JsonObject()
          .put("message", "Resource not found")
          .encode())
        );

        {{#rxInterface}}return server.rxListen()
          .doOnSuccess(server -> LOGGER.info("{{classname}}Verticle started on port " + server.actualPort()));
      })
      .ignoreElement();
  }

  @Override
  public Completable rxStop() {
    return this.server.rxClose();
  }{{/rxInterface}}
        {{^rxInterface}}return server.listen()
          .onSuccess(server -> LOGGER.info("{{classname}}Verticle started on port " + server.actualPort()));
      })
      .onSuccess(server -> startPromise.complete())
      .onFailure(startPromise::fail);
  }

  @Override
  public void stop(Promise<Void> stopPromise) throws Exception {
    this.server.close()
      .onSuccess(server -> stopPromise.complete())
      .onFailure(stopPromise::fail);
  }{{/rxInterface}}

}
